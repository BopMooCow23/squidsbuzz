<!DOCTYPE html>
<html lang="en-us">
  <head>
    <base href="">
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="viewport"
      content="width=device-width, height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Unity WebGL Player | Raft</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
        overflow: hidden;
      }
      body {
        background: #000;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      .webgl-content {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #unityContainer {
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/genizy/web-port@main/raft/Build/UnityLoader.js"></script>
    <script>
      let max = 0;
      let done = 0;

      // merge parts into blob URL
      function mergeFiles(fileParts) {
        return new Promise((resolve, reject) => {
          let buffers = [];

          function fetchPart(index) {
            if (index >= fileParts.length) {
              let mergedBlob = new Blob(buffers);
              let mergedFileUrl = URL.createObjectURL(mergedBlob);
              resolve(mergedFileUrl);
              return;
            }
            fetch(fileParts[index])
              .then((response) => {
                if (!response.ok) throw new Error("Failed to load " + fileParts[index]);
                return response.arrayBuffer();
              })
              .then((data) => {
                buffers.push(data);
                done += 1;
                document.querySelector("#loading-text").textContent = `LOADING... (${done}/${max})`;
                fetchPart(index + 1);
              })
              .catch((err) => {
                reject(err);
              });
          }
          fetchPart(0);
        });
      }

      // patch UnityLoader
      UnityLoader.downloadJob = function (e, t) {
        var r = new XMLHttpRequest();
        if (t.parameters.url.startsWith("Build/blob")) {
          r.open("GET", t.parameters.url.replace("Build/", ""));
        } else {
          r.open("GET", t.parameters.url);
        }
        r.responseType = "arraybuffer";
        r.onload = function () {
          UnityLoader.Compression.decompress(new Uint8Array(r.response), function (e) {
            t.complete(e);
          });
        };
        t.parameters.onprogress && r.addEventListener("progress", t.parameters.onprogress);
        t.parameters.onload && r.addEventListener("load", t.parameters.onload);
        r.send();
      };

      const dataParts = [
        "https://cdn.jsdelivr.net/gh/swdbuzz/Raftdata1-2@main/Raft-WEBGL.data.unityweb.part1",
        "https://cdn.jsdelivr.net/gh/swdbuzz/Raftdata1-2@main/Raft-WEBGL.data.unityweb.part2",
        "https://cdn.jsdelivr.net/gh/swdbuzz/Raftdata3@main/Raft-WEBGL.data.unityweb.part3"
      ];

      const asmCodeParts = [
        "https://cdn.jsdelivr.net/gh/swdbuzz/Raftcode@main/Raft-WEBGL.asm.code.unityweb.part1",
        "https://cdn.jsdelivr.net/gh/swdbuzz/Raftcode@main/Raft-WEBGL.asm.code.unityweb.part2"
      ];

      max = dataParts.length + asmCodeParts.length;

      function resizeUnityContainer() {
        var container = document.getElementById("unityContainer");
        container.style.width = window.innerWidth + "px";
        container.style.height = window.innerHeight + "px";
      }

      // merge and start
      Promise.all([
        mergeFiles(dataParts),
        mergeFiles(asmCodeParts)
      ]).then(([dataUrl, asmCodeUrl]) => {
        const json = {
          "TOTAL_MEMORY": 268435456,
          "dataUrl": dataUrl,
          "asmCodeUrl": asmCodeUrl,
          "asmMemoryUrl": "https://cdn.jsdelivr.net/gh/swdbuzz/Raftcode@main/Raft-WEBGL.asm.memory.unityweb",
          "asmFrameworkUrl": "https://cdn.jsdelivr.net/gh/swdbuzz/Raftcode@main/Raft-WEBGL.asm.framework.unityweb",
          "splashScreenStyle": "Dark",
          "backgroundColor": "#000000"
        };

        let blob = new Blob([JSON.stringify(json)], { type: "application/json" });
        let blobUrl = URL.createObjectURL(blob);

        window.addEventListener("resize", resizeUnityContainer);

        UnityLoader.instantiate("unityContainer", json, {
          url: blobUrl,
          Module: {
            onRuntimeInitialized: function () {
              resizeUnityContainer();
              document.querySelector("#loading-text").remove();
            },
          },
        });
      }).catch(err => {
        document.querySelector("#loading-text").textContent = "ERROR: " + err.message;
      });
    </script>
  </head>

  <body>
    <div class="webgl-content">
      <div
        id="loading-text"
        style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;"
      >
        LOADING...
      </div>
      <div id="unityContainer"></div>
    </div>
  </body>
</html>