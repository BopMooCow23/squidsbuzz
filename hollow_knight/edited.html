<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Hollow Knight</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico.html">
    <link rel="stylesheet" href="TemplateData/style.css.html">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #231F20;
        }
        #unity-container {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <div id="loading-text" style="color: white; font-size: 48px; font-family: cursive; text-align: center; margin-top: 20px;">LOADING...</div>
    <div hidden id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas"></canvas>
        <div id="unity-loading-bar">
            <div id="unity-logo"></div>
            <div id="unity-progress-bar-empty">
                <div id="unity-progress-bar-full"></div>
            </div>
        </div>
        <div id="unity-mobile-warning">WebGL builds are not supported on mobile devices.</div>
    </div>

    <script>
        var loadingText = document.querySelector("#loading-text");
        let totalBytes = 0;
        let loadedBytes = 0;

        async function getSize(url) {
            try {
                const res = await fetch(url, { method: "HEAD" });
                return parseInt(res.headers.get("Content-Length") || "0", 10);
            } catch {
                return 0;
            }
        }

        async function fetchWithProgress(url) {
            const response = await fetch(url);
            const reader = response.body.getReader();
            let chunks = [];
            let received = 0;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                received += value.length;
                loadedBytes += value.length;
                chunks.push(value);
                let mbDone = (loadedBytes / (1024 * 1024)).toFixed(2);
                let mbTotal = '909.17';
                loadingText.textContent = `LOADING... ${mbDone} MB / ${mbTotal} MB`;
            }

            let fullBuffer = new Uint8Array(received);
            let offset = 0;
            for (let chunk of chunks) {
                fullBuffer.set(chunk, offset);
                offset += chunk.length;
            }
            return fullBuffer.buffer;
        }

        async function mergeFiles(fileParts) {
            const buffers = await Promise.all(fileParts.map(part => fetchWithProgress(part)));
            const mergedBlob = new Blob(buffers);
            return URL.createObjectURL(mergedBlob);
        }

        (async () => {
            // Explicit list of all file parts with your provided URLs
            const bogDataParts = [
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk1-2@main/hk.data.part1",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk1-2@main/hk.data.part2",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk3-4@main/hk.data.part3",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk3-4@main/hk.data.part4",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk5-6@main/hk.data.part5",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk5-6@main/hk.data.part6",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk7-8@main/hk.data.part7",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk7-8@main/hk.data.part8",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk10-11@main/hk.data.part9",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk10-11@main/hk.data.part10",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk12-13@main/hk.data.part11",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk12-13@main/hk.data.part12",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk14-15@main/hk.data.part13",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk14-15@main/hk.data.part14",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk16-17@main/hk.data.part15",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk16-17@main/hk.data.part16",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk18-19@main/hk.data.part17",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk18-19@main/hk.data.part18",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk20-21@main/hk.data.part19",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk20-21@main/hk.data.part20",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk22-23@main/hk.data.part21",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk22-23@main/hk.data.part22",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk24-25@main/hk.data.part23",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk24-25@main/hk.data.part24",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk26-27@main/hk.data.part25",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk26-27@main/hk.data.part26",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk28-29@main/hk.data.part27",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk28-29@main/hk.data.part28",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk30-31@main/hk.data.part29",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk30-31@main/hk.data.part30",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk32-33@main/hk.data.part31",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk32-33@main/hk.data.part32",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk34-35@main/hk.data.part33",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk34-35@main/hk.data.part34",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk36-37@main/hk.data.part35",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk36-37@main/hk.data.part36",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk38-39@main/hk.data.part37",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk38-39@main/hk.data.part38",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk40-41@main/hk.data.part39",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk40-41@main/hk.data.part40",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk42@main/hk.data.part41",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk42@main/hk.data.part42"
            ];

            // Replace these with your actual WASM part URLs if they exist
            const bogWasmParts = [
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk-others@main/hk.wasm.part1",
                "https://cdn.jsdelivr.net/gh/swdbuzz/hk-others@main/hk.wasm.part2"
            ];

            const sizes = await Promise.all([...bogDataParts, ...bogWasmParts].map(getSize));
            totalBytes = sizes.reduce((a, b) => a + b, 0);

            const [dataUrl, wasmUrl] = await Promise.all([
                mergeFiles(bogDataParts),
                mergeFiles(bogWasmParts),
            ]);

            var buildUrl = "Build";
            var loaderUrl = "https://cdn.jsdelivr.net/gh/swdbuzz/hk-others@main/hk.loader.js";

            var config = {
                dataUrl: dataUrl,
                frameworkUrl: "https://cdn.jsdelivr.net/gh/swdbuzz/hk-others@main/hk.framework.js",
                codeUrl: wasmUrl,
                streamingAssetsUrl: "StreamingAssets",
                companyName: "Team Cherry & Truffled",
                productName: "Hollow Knight",
                productVersion: "1.0",
            };

            var container = document.querySelector("#unity-container");
            container.hidden = false;
            var canvas = document.querySelector("#unity-canvas");
            var loadingBar = document.querySelector("#unity-loading-bar");
            var progressBarFull = document.querySelector("#unity-progress-bar-full");
            var mobileWarning = document.querySelector("#unity-mobile-warning");

            // Handle mobile
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
                container.className = "unity-mobile";
                config.devicePixelRatio = 1;
                mobileWarning.style.display = "block";
                setTimeout(() => {
                    mobileWarning.style.display = "none";
                }, 5000);
            } else {
                function resizeCanvas() {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                    canvas.style.width = window.innerWidth + "px";
                    canvas.style.height = window.innerHeight + "px";
                }
                resizeCanvas();
                window.addEventListener('resize', resizeCanvas);
            }

            loadingBar.style.display = "block";

            var script = document.createElement("script");
            script.src = loaderUrl;
            script.onload = () => {
                createUnityInstance(canvas, config, (progress) => {
                    progressBarFull.style.width = 100 * progress + "%";
                }).then((unityInstance) => {
                    loadingText.remove();
                    loadingBar.style.display = "none";
                    canvas.style.display = "block";
                }).catch((message) => {
                    alert(message);
                });
            };
            document.body.appendChild(script);
        })();
    </script>
</body>
</html>